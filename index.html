<!doctype html>
<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
		<script src="rot.min.js"></script>
		<script src="xy.js"></script>
		<script src="map.js"></script>
		<script src="controller.js"></script>
		<script src="assembler.js"></script>
		<script src="rendercontroller.js"></script>
		<script src="instruction.js"></script>
		<script src="roverstatus.js"></script>
		<script src="rover.js"></script>
		<script src="game.js"></script>
	</head>
	<body onload="Game.init($('#gamediv'))">
		<div id="gamediv"></div>
		<div><textarea id="assembly" cols="100" rows="25">	LDR	!127
	STR	[!1]
LOP	LDR	[!2]
	CMP	!4
	JEQ	TRN
	JMP LOP
TRN	LDR	!0
	STR	[!1]
	LDR	!127
	STR	[!0]
	HLT	0</textarea> <div id="tdiv" style="display: inline-block; vertical-align: top; font-family: monospace"></div><div style="vertical-align: bottom; display: inline-block"><button id="asmbtn">Assemble</button> <button id="load">Load</button></div></div>
		<script type="text/javascript">
			$(document).delegate('#assembly', 'keydown', function(e) {
				var keycode = e.keyCode || e.which;

				// From: http://stackoverflow.com/questions/6637341/use-tab-to-indent-in-textarea
				if (keycode == 9) {
				    e.preventDefault();
				    var start = $(this).get(0).selectionStart;
				    var end = $(this).get(0).selectionEnd;

				    // set textarea value to: text before caret + tab + text after caret
				    $(this).val($(this).val().substring(0, start)
				                + "\t"
				                + $(this).val().substring(end));

				    // put caret at right position again
				    $(this).get(0).selectionStart =
				    $(this).get(0).selectionEnd = start + 1;
				}
			});
			$(document).ready(function() {
				$('#asmbtn').on('click', function() {
					var asm = new Assembler($('#assembly').val());
					var cmp = asm.assemble();
					cmp = new Uint8Array(cmp);
					window.localStorage.setItem("rover-program", Assembler.serialize(cmp));
					var html = '';
					for (var i = 0; i < cmp.length; i += 2) {
						html = html + '<br />' +
						fmt_bin(cmp[i]) +
						'&nbsp;&nbsp;&nbsp;' +
						fmt_bin(cmp[i+1]);
					}
					$('#tdiv').html(html);
				});
				$('#load').on('click', function() {
					var prog = Assembler.deserialize(window.localStorage.getItem("rover-program"));
					/*
					var asmUrl = JSON.parse(window.localStorage.getItem("rover-program"));
					var xhr = new XMLHttpRequest();
					xhr.open("GET", asmUrl, true);
					xhr.responseType = "arraybuffer";
					xhr.addEventListener("load", function() {
						if (xhr.status === 200) {
							blob = new Blob([xhr.response], {type: "application/octet-binary"});
							var reader = new FileReader();
							reader.addEventListener("load", function(evt) {
								var u8a = new Uint8Array(reader.result);
								Game.reset_rover(u8a);
							});
							reader.readAsArrayBuffer(blob);
						}
					}, false);

					xhr.send();
					*/
					Game.reset_rover(prog);
				});
			});
			
			function fmt_bin(num) {
			  var rstr = num.toString(2);
			  rstr = "00000000" + rstr;
			  rstr = rstr.substr(rstr.length - 8);
			  rstr = rstr.substr(0, 4) + " " + rstr.substr(4);
			  return rstr;
			}
		</script>
	</body>
</html>
